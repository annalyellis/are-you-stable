<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Balance Journey</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://unpkg.com/scrollama@3.2.0/build/scrollama.min.js"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    
    <style>
        body {
            font-family: 'Inter', sans-serif;
            scroll-behavior: smooth;
            background-color: #f0f4f8;
            color: #334155;
            margin: 0;
            padding: 0;
        }

        /* Scrollytelling Container */
        .scrolly-container {
            display: flex;
            align-items: flex-start;
            position: relative;
            min-height: 100vh;
            background-color: #f8fafc;
        }

        /* Graphic Area - Stays Fixed/Sticky */
        .scrolly-graphic {
            position: sticky;
            top: 0;
            width: 50%;
            height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background-color: #f8fafc;
            z-index: 5;
            overflow: hidden;
        }

        .scrolly-graphic canvas {
            width: 100%;
            height: 80%;
            display: block;
        }

        /* Balance scale visualization */
        .balance-scale {
            width: 80%;
            max-width: 400px;
            height: 60px;
            margin-top: 20px;
            position: relative;
            background: linear-gradient(to right, #ef4444 0%, #f97316 25%, #facc15 50%, #22c55e 75%, #22c55e 100%);
            border-radius: 30px;
            border: 2px solid #334155;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        .balance-indicator {
            position: absolute;
            top: -5px;
            width: 20px;
            height: 70px;
            background-color: #334155;
            border-radius: 10px;
            transition: left 0.8s ease-in-out;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }

        .balance-indicator::after {
            content: '';
            position: absolute;
            top: -5px;
            left: 50%;
            transform: translateX(-50%);
            width: 0;
            height: 0;
            border-left: 8px solid transparent;
            border-right: 8px solid transparent;
            border-bottom: 10px solid #334155;
        }

        .balance-labels {
            display: flex;
            justify-content: space-between;
            margin-top: 10px;
            font-size: 12px;
            color: #64748b;
            font-weight: 600;
        }

        /* Text Area - Scrolls */
        .scrolly-text {
            width: 50%;
            z-index: 10;
            background-color: white;
            box-shadow: -5px 0 15px -3px rgba(0, 0, 0, 0.05);
        }

        /* Individual Step Sections */
        .scrolly-section {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 2rem;
            text-align: center;
            border-bottom: 1px solid #e2e8f0;
        }
        .scrolly-section:last-of-type {
            border-bottom: none;
        }

        .section-content {
            max-width: 800px;
            margin-bottom: 2rem;
        }

        /* Quiz Section Styles */
        .intro-section {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 2rem;
            text-align: center;
            background-color: #f0f4f8;
            color: #334155;
        }

        .intro-section h1 {
            font-size: 3.5rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: #1e293b;
        }

        .intro-section p {
            font-size: 1.25rem;
            color: #475569;
            margin-bottom: 2rem;
            max-width: 600px;
        }

        .navigation-buttons {
            margin-top: 2rem;
        }

        .navigation-buttons button {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3), 0 2px 4px -1px rgba(59, 130, 246, 0.1);
            margin: 0 0.5rem;
        }

        .navigation-buttons button:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }

        .navigation-buttons button:active {
            transform: translateY(0);
        }

        #quizContainer {
            display: none;
            min-height: 100vh;
            padding: 2rem;
            background-color: #f8fafc;
            color: #334155;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background-color: #e2e8f0;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 2rem;
        }

        .progress-fill {
            height: 100%;
            background-color: #3b82f6;
            transition: width 0.3s ease;
            width: 0%;
        }

        .step {
            display: none;
            max-width: 800px;
            margin: 0 auto;
            background-color: white;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .step.active {
            display: block;
        }

        .step h2 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 1.5rem;
            color: #1e293b;
        }

        .question {
            margin-bottom: 1.5rem;
        }

        .question label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .question input, .question select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        .question input:focus, .question select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        /* Likert Scale Styles */
        .likert-scale {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .likert-option {
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: #f9fafb;
        }

        .likert-option:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .likert-option.selected {
            border-color: #3b82f6;
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: 600;
        }

        .likert-option div:first-child {
            font-size: 0.875rem;
            margin-bottom: 0.25rem;
        }

        .likert-option div:last-child {
            font-size: 1.25rem;
            font-weight: bold;
        }

        /* TMT Grid Styles */
        .tmt-grid {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 10px;
            max-width: 400px;
            margin: 2rem auto;
            padding: 1rem;
            background-color: #f8fafc;
            border-radius: 0.75rem;
        }

        .tmt-circle {
            width: 60px;
            height: 60px;
            border: 2px solid #64748b;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.25rem;
            cursor: pointer;
            background-color: white;
            transition: all 0.2s ease;
        }

        .tmt-circle:hover {
            border-color: #3b82f6;
            background-color: #eff6ff;
        }

        .tmt-circle.current {
            border-color: #f59e0b;
            background-color: #fef3c7;
            animation: pulse 1s infinite;
        }

        .tmt-circle.completed {
            border-color: #10b981;
            background-color: #d1fae5;
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .tmt-timer {
            text-align: center;
            font-size: 1.25rem;
            font-weight: bold;
            margin: 1rem 0;
            color: #374151;
        }

        /* Results Styles */
        #mainContent {
            display: none;
            width: 100vw;
            height: 100vh;
            background-color: white;
        }

        .full-screen-results {
            display: flex !important;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            width: 100vw;
            height: 100vh;
            position: fixed;
            top: 0;
            left: 0;
            background-color: white;
            z-index: 999;
            overflow: auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .explore-results-btn {
            background-color: #3b82f6;
            color: white;
            padding: 0.75rem 1.5rem;
            border-radius: 0.75rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s ease-in-out, transform 0.1s ease-in-out;
            border: none;
            box-shadow: 0 4px 6px -1px rgba(59, 130, 246, 0.3), 0 2px 4px -1px rgba(59, 130, 246, 0.1);
            margin-top: 2rem;
        }

        .explore-results-btn:hover {
            background-color: #2563eb;
            transform: translateY(-2px);
        }

        /* Media queries for responsiveness */
        @media (max-width: 768px) {
            .scrolly-container {
                flex-direction: column;
            }
            .scrolly-graphic, .scrolly-text {
                width: 100%;
            }
            .scrolly-graphic {
                height: 50vh;
                position: sticky;
                top: 0;
            }
            .scrolly-section {
                min-height: 75vh;
            }
            .likert-scale {
                grid-template-columns: repeat(2, 1fr);
            }
            .tmt-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="scrolly-container">
        <div class="scrolly-graphic">
            <canvas id="main-canvas"></canvas>
            <div class="balance-scale">
                <div class="balance-indicator" id="balance-indicator"></div>
            </div>
            <div class="balance-labels">
                <span>Poor Balance</span>
                <span>Excellent Balance</span>
            </div>
        </div>
        <div class="scrolly-text">
            <div class="scrolly-section" data-age="intro">
                <div class="section-content">
                    <h1 class="text-5xl font-bold mb-6 text-gray-800">The Age of Balance: Joe's Journey Through Life</h1>
                    <p class="text-xl text-gray-600 mb-8">Scroll down to follow Joe's fascinating journey and discover how balance evolves throughout our lives. Watch the balance meter on the left!</p>
                    <i class="fas fa-chevron-down text-4xl text-blue-500 animate-bounce"></i>
                </div>
            </div>

            <div class="scrolly-section" data-age="toddler">
                <div class="section-content">
                    <h2 class="text-4xl font-bold mb-4 text-gray-800">Joe as a Toddler: Wobbly Beginnings</h2>
                    <p class="text-lg text-gray-700">From crawling to taking his first steps, Joe's toddler years are a masterclass in learning balance. Every stumble is a lesson, as his brain and muscles work tirelessly to coordinate movements and maintain an upright posture. It's a period of rapid development, filled with adorable wobbles and triumphant steps.</p>
                    <p class="text-md text-gray-600 mt-4">At this stage, core strength, visual input, and trial-and-error are crucial for building foundational balance skills.</p>
                </div>
            </div>

            <div class="scrolly-section" data-age="20">
                <div class="section-content">
                    <h2 class="text-4xl font-bold mb-4 text-gray-800">Joe at 20: The Peak of Stability</h2>
                    <p class="text-lg text-gray-700">At 20, Joe feels invincible. His balance is at its peak, rarely a second thought. Whether he's playing sports, dancing, or just navigating a crowded street, his body's systems work in perfect harmony to keep him upright and agile.</p>
                    <p class="text-md text-gray-600 mt-4">This is when proprioception (body awareness), vestibular function (inner ear balance), and strong muscles are all working optimally.</p>
                </div>
            </div>

            <div class="scrolly-section" data-age="40">
                <div class="section-content">
                    <h2 class="text-4xl font-bold mb-4 text-gray-800">Joe at 40: Subtle Shifts Begin</h2>
                    <p class="text-lg text-gray-700">By 40, life gets busy. Joe might not notice it, but his reaction time and spatial awareness begin a subtle, gradual decline. He might occasionally stumble over an unseen obstacle or feel a slight wobble when standing on one leg. These changes are often imperceptible in daily life but mark the beginning of age-related balance shifts.</p>
                    <p class="text-md text-gray-600 mt-4">Factors like reduced muscle mass, less flexible joints, and minor changes in sensory input can contribute to these early shifts.</p>
                </div>
            </div>

            <div class="scrolly-section" data-age="60">
                <div class="section-content">
                    <h2 class="text-4xl font-bold mb-4 text-gray-800">Joe at 60: Noticing the Changes</h2>
                    <p class="text-lg text-gray-700">At 60, Joe's body is changing more noticeably. He might find himself reaching for support more often, especially on uneven surfaces or in low light. Regular exercise and mindful movement become crucial for maintaining his stability and preventing falls. He's more aware of the need to be careful.</p>
                    <p class="text-md text-gray-600 mt-4">Vision changes, slower nerve impulses, and decreased strength in core and leg muscles play a significant role here.</p>
                </div>
            </div>

            <div class="scrolly-section" data-age="80">
                <div class="section-content">
                    <h2 class="text-4xl font-bold mb-4 text-gray-800">Joe at 80+: The Unforeseen Fall</h2>
                    <p class="text-lg text-gray-700">Into his 80s, Joe's balance becomes severely compromised. Despite his best efforts to stay active and cautious, a sudden loss of stability leads to a fall. This moment highlights the critical importance of fall prevention strategies and the impact of age on our physical autonomy.</p>
                    <p class="text-md text-gray-600 mt-4">Falls in older adults can have significant consequences, emphasizing the need for environmental modifications, regular strength and balance training, and medical consultation.</p>
                </div>
            </div>
        </div> 
    </div> 
    
    <section id="introSection" class="intro-section">
        <h1>Are you stable?</h1>
        <p>
            Balance is a crucial aspect of physical health 
            that enables safe movement, coordination, and stability in 
            everyday activities. As we age, maintaining good balance becomes 
            increasingly important to prevent falls and support long-term 
            mobility and independence.
        </p>
        <div class="navigation-buttons">
            <button id="toQuizbtn">Let's Find Out!</button>
        </div>
    </section>

    <div id="quizContainer">
        <div class="progress-bar">
            <div id="progressFill" class="progress-fill"></div>
        </div>

        <div id="step0" class="step active">
            <h2>Welcome to the Balance Assessment!</h2>
            <p>This quiz will assess your balance and provide personalized insights. It involves several steps, including questions about your physical activity and a simple motor test.</p>
            <div class="navigation-buttons">
                <button id="startQuizBtn" onclick="goToStep(1)">Start Quiz</button>
            </div>
        </div>

        <div id="step1" class="step">
            <h2>1. Personal Information</h2>
            <div class="question">
                <label for="age">Age:</label>
                <input type="number" id="age" name="age" min="1" max="120" required>
            </div>
            <div class="question">
                <label for="gender">Gender:</label>
                <select id="gender" name="gender" required>
                    <option value="">Select</option>
                    <option value="male">Male</option>
                    <option value="female">Female</option>
                    <option value="other">Other</option>
                </select>
            </div>
            <div class="question">
                <label for="height">Height (inches):</label>
                <input type="number" id="height" name="height" min="20" max="100" step="0.1" required>
            </div>
            <div class="question">
                <label for="weight">Weight (pounds):</label>
                <input type="number" id="weight" name="weight" min="50" max="1000" step="0.1" required>
            </div>
            <div class="navigation-buttons">
                <button id="prevBtn1" onclick="prevStep()" style="display: none;">Previous</button>
                <button id="nextBtn1" onclick="nextStep()">Next</button>
            </div>
        </div>

        <div id="step2" class="step">
            <h2>2. Falls Efficacy Scale - International (FES-I)</h2>
            <p>Please indicate your level of concern about falling during the following activities:</p>
            <div id="fesQuestions"></div>
            <div class="navigation-buttons">
                <button id="prevBtn2" onclick="prevStep()">Previous</button>
                <button id="nextBtn2" onclick="nextStep()">Next</button>
            </div>
        </div>

        <div id="step3" class="step">
            <h2>3. International Physical Activity Questionnaire (IPAQ)</h2>
            <div class="question">
                <label for="ipaq1a">In the last 7 days, on how many days did you do **vigorous** physical activities like heavy lifting, digging, aerobics, or fast bicycling?</label>
                <input type="number" id="ipaq1a" name="ipaq1a" min="0" max="7" required>
            </div>
            <div class="question">
                <label for="ipaq1b">How much time did you spend on one of those days doing vigorous physical activities? (minutes per day)</label>
                <input type="number" id="ipaq1b" name="ipaq1b" min="0" required>
            </div>
            <div class="question">
                <label for="ipaq2a">In the last 7 days, on how many days did you do **moderate** physical activities like carrying light loads, bicycling at a regular pace, or doubles tennis? (Don't include walking)</label>
                <input type="number" id="ipaq2a" name="ipaq2a" min="0" max="7" required>
            </div>
            <div class="question">
                <label for="ipaq2b">How much time did you spend on one of those days doing moderate physical activities? (minutes per day)</label>
                <input type="number" id="ipaq2b" name="ipaq2b" min="0" required>
            </div>
            <div class="navigation-buttons">
                <button id="prevBtn3" onclick="prevStep()">Previous</button>
                <button id="nextBtn3" onclick="nextStep()">Next</button>
            </div>
        </div>

        <div id="step4" class="step">
            <h2>4. Trail Making Test (TMT) - Part A (Numbers)</h2>
            <p>Click on the numbers in ascending order (1, 2, 3, ...). The timer starts when you click 'Start'.</p>
            <div class="tmt-grid" id="tmtGrid"></div>
            <div class="tmt-timer" id="tmtTimer">Ready to start</div>
            <div class="navigation-buttons">
                <button id="tmtStartBtn" onclick="startTMT()">Start Test</button>
                <button id="prevBtn4" onclick="prevStep()">Previous</button>
                <button id="tmtNextBtn" onclick="nextStep()" disabled>Next</button>
            </div>
        </div>

        <div id="step5" class="step">
            <h2>5. Submit Assessment</h2>
            <p>Click 'Submit' to calculate your balance score and see your personalized results.</p>
            <div class="navigation-buttons">
                <button id="prevBtn5" onclick="prevStep()">Previous</button>
                <button id="submitBtn" onclick="calculateResults()">Submit</button>
            </div>
        </div>
    </div>

    <div id="mainContent">
        <div id="resultsPane">
            <h2>Your Predicted Mini-BESTest Score: <span id="predictedScore"></span></h2>
            <div id="scoreInterpretation"></div>
            <div id="recommendations"></div>
            <div id="comparisonChart"></div>
            <div style="text-align: center; margin-top: 20px;">
                <button class="navigation-buttons button" onclick="downloadScore()">Download My Score</button>
                <button class="navigation-buttons button" onclick="resetAssessment()">Start New Assessment</button>
            </div>
        </div>
    </div>

    <script>
        // Global variables
        let currentStep = 0;
        let assessmentData = {};
        let tmtStartTime = null;
        let tmtCurrentNumber = 1;
        let tmtCompleted = false;
        let finalPredictedScore = null;
        let currentActiveAge = null;
        let animationFrameId = null;

        // FES-I Questions
        const fesQuestions = [
            "Cleaning the house (e.g. sweep, vacuum, or dust)",
            "Getting dressed or un-dressed",
            "Preparing simple meals",
            "Taking a bath or shower",
            "Going to the shop",
            "Getting in or out of a chair",
            "Going up or down stairs",
            "Walking around the house",
            "Walking on a slippery surface (e.g. wet floor, ice)",
            "Walking on an uneven surface (e.g. stony path, grass)",
            "Walking in a place with crowds (e.g. shopping center, street)",
            "Walking up or down a slope",
            "Visiting friends or relatives",
            "Going to a place with stairs or steps",
            "Going for a social event (e.g. club, religious meeting, party)",
            "Going to the doctor's clinic or hospital"
        ];

        // Balance scale position mapping
        const balancePositions = {
            'intro': 50,
            'toddler': 25,
            20: 85,
            40: 70,
            60: 40,
            80: 15
        };

        // Canvas and scrollytelling functions
        const mainCanvas = document.getElementById('main-canvas');
        const mainCtx = mainCanvas.getContext('2d');
        const balanceIndicator = document.getElementById('balance-indicator');

        function updateBalanceIndicator(age) {
            const position = balancePositions[age] || 50;
            balanceIndicator.style.left = `calc(${position}% - 10px)`;
        }

        function drawJoe(ctx, x, yBase, scale, tiltAngle = 0, wobble = 0, hasBraces = false, stoopAngle = 0, isFallen = false) {
            ctx.save();
            ctx.translate(x, yBase);
            ctx.rotate(tiltAngle);

            const headRadius = 10 * scale;
            const bodyLength = 40 * scale;
            const limbLength = 30 * scale;

            if (isFallen) {
                ctx.save();
                ctx.rotate(Math.PI / 2);

                ctx.beginPath();
                ctx.moveTo(-bodyLength / 2, 0);
                ctx.lineTo(bodyLength / 2, 0);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(-bodyLength * 0.2, 0);
                ctx.lineTo(-bodyLength * 0.2 - limbLength * 0.5, limbLength * 0.7);
                ctx.moveTo(bodyLength * 0.2, 0);
                ctx.lineTo(bodyLength * 0.2 + limbLength * 0.5, limbLength * 0.7);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(-bodyLength * 0.3, 0);
                ctx.lineTo(-bodyLength * 0.3 - limbLength * 0.4, -limbLength * 0.6);
                ctx.moveTo(bodyLength * 0.3, 0);
                ctx.lineTo(bodyLength * 0.3 + limbLength * 0.4, -limbLength * 0.6);
                ctx.stroke();

                ctx.beginPath();
                ctx.arc(bodyLength / 2 + headRadius, 0, headRadius, 0, Math.PI * 2);
                ctx.fill();

                ctx.restore();
                ctx.restore();
                return;
            }

            const currentWobble = Math.sin(Date.now() * 0.005) * wobble;
            ctx.rotate(currentWobble);

            ctx.lineWidth = 2 * scale;
            ctx.strokeStyle = '#334155';
            ctx.fillStyle = '#334155';

            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(-limbLength * 0.5, limbLength);
            ctx.moveTo(0, 0);
            ctx.lineTo(limbLength * 0.5, limbLength);
            ctx.stroke();

            ctx.save();
            ctx.rotate(-stoopAngle);
            ctx.beginPath();
            ctx.moveTo(0, 0);
            ctx.lineTo(0, -bodyLength);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(0, -bodyLength * 0.75);
            ctx.lineTo(-limbLength * 0.7, -bodyLength * 0.5);
            ctx.moveTo(0, -bodyLength * 0.75);
            ctx.lineTo(limbLength * 0.7, -bodyLength * 0.5);
            ctx.stroke();

            ctx.beginPath();
            ctx.arc(0, -bodyLength - headRadius, headRadius, 0, Math.PI * 2);
            ctx.fill();

            if (hasBraces) {
                ctx.fillStyle = '#a0aec0';
                const braceWidth = 16 * scale;
                const braceHeight = 3 * scale;
                ctx.fillRect(-braceWidth / 2, -bodyLength - headRadius * 0.5 + 5 * scale, braceWidth, braceHeight);
                ctx.fillRect(-braceWidth / 2, -bodyLength - headRadius * 0.4 + 5 * scale, braceWidth, braceHeight);
            }
            ctx.restore();
            ctx.restore();
        }

        function drawBalanceVisualization(ctx, age) {
            if (!ctx) return;

            ctx.canvas.width = ctx.canvas.offsetWidth;
            ctx.canvas.height = ctx.canvas.offsetHeight;
            ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);

            const centerX = ctx.canvas.width / 2;
            const joeGroundY = ctx.canvas.height * 0.8;
            const baseScale = Math.min(ctx.canvas.width, ctx.canvas.height) / 300;

            let joeTilt = 0;
            let joeWobble = 0;
            let joeImageScale = 1;
            let hasBraces = false;
            let showCane = false;
            let stoopAngle = 0;
            let isFallen = false;

            switch (age) {
                case 'intro':
                    joeImageScale = 0.3;
                    joeTilt = 0;
                    joeWobble = 0;
                    hasBraces = false;
                    showCane = false;
                    stoopAngle = 0;
                    isFallen = false;
                    break;
                case 'toddler':
                    joeImageScale = 0.6;
                    joeTilt = Math.sin(Date.now() * 0.008) * 0.25;
                    joeWobble = 0.15;
                    hasBraces = false;
                    showCane = false;
                    stoopAngle = 0;
                    isFallen = false;
                    break;
                case 20:
                    joeImageScale = 1.0;
                    hasBraces = true;
                    joeTilt = 0;
                    joeWobble = 0;
                    showCane = false;
                    stoopAngle = 0;
                    isFallen = false;
                    break;
                case 40:
                    joeImageScale = 1.0;
                    joeTilt = Math.sin(Date.now() * 0.003) * 0.1;
                    joeWobble = 0.05;
                    hasBraces = false;
                    showCane = false;
                    stoopAngle = 0.05;
                    isFallen = false;
                    break;
                case 60:
                    joeImageScale = 1.0;
                    joeTilt = Math.sin(Date.now() * 0.004) * 0.2;
                    joeWobble = 0.1;
                    hasBraces = false;
                    showCane = false;
                    stoopAngle = 0.2;
                    isFallen = false;
                    break;
                case 80:
                    joeImageScale = 0.8;
                    joeTilt = Math.sin(Date.now() * 0.005) * 0.3;
                    joeWobble = 0.15;
                    hasBraces = false;
                    showCane = true;
                    stoopAngle = 0.35;
                    isFallen = Math.sin(Date.now() * 0.002) > 0.7;
                    break;
            }

            drawJoe(ctx, centerX, joeGroundY, baseScale * joeImageScale, joeTilt, joeWobble, hasBraces, stoopAngle, isFallen);

            ctx.beginPath();
            ctx.moveTo(centerX - 100 * baseScale, joeGroundY);
            ctx.lineTo(centerX + 100 * baseScale, joeGroundY);
            ctx.lineWidth = 3 * baseScale;
            ctx.strokeStyle = '#64748b';
            ctx.stroke();

            if (showCane && !isFallen) {
                ctx.font = `${45 * baseScale}px "Font Awesome 6 Free"`;
                ctx.fillStyle = '#8B4513';
                ctx.fillText('\uf787', centerX + 35 * baseScale * joeImageScale, joeGroundY + 5 * baseScale);
            }

            if (age === currentActiveAge) {
                animationFrameId = requestAnimationFrame(() => drawBalanceVisualization(ctx, age));
            }
        }

        function handleStepEnter(response) {
            if (animationFrameId) {
                cancelAnimationFrame(animationFrameId);
                animationFrameId = null;
            }

            const age = response.element.dataset.age;
            currentActiveAge = age;
            
            updateBalanceIndicator(age);
            drawBalanceVisualization(mainCtx, age);
        }

        function setupScrollama() {
            if (typeof scrollama === 'undefined') {
                console.error('Scrollama not available, using fallback');
                useScrollFallback();
                return;
            }

            try {
                const scroller = scrollama();
                scroller
                    .setup({
                        step: '.scrolly-section',
                        offset: 0.5,
                    })
                    .onStepEnter(handleStepEnter);
            } catch (error) {
                console.error('Scrollama setup failed:', error);
                useScrollFallback();
            }
        }

        function useScrollFallback() {
            function checkScroll() {
                const sections = document.querySelectorAll('.scrolly-section');
                const windowHeight = window.innerHeight;
                
                sections.forEach(section => {
                    const rect = section.getBoundingClientRect();
                    const isVisible = rect.top < windowHeight * 0.5 && rect.bottom > windowHeight * 0.5;
                    
                    if (isVisible) {
                        const age = section.dataset.age;
                        if (age !== currentActiveAge) {
                            if (animationFrameId) {
                                cancelAnimationFrame(animationFrameId);
                                animationFrameId = null;
                            }
                            
                            currentActiveAge = age;
                            updateBalanceIndicator(age);
                            drawBalanceVisualization(mainCtx, currentActiveAge);
                        }
                    }
                });
            }
            
            let scrollTimeout;
            window.addEventListener('scroll', function() {
                if (scrollTimeout) {
                    clearTimeout(scrollTimeout);
                }
                scrollTimeout = setTimeout(checkScroll, 50);
            });
            
            checkScroll();
        }

        // Quiz functions
        function startQuizFromIntro() {
            document.getElementById('introSection').style.display = 'none';
            document.getElementById('quizContainer').style.display = 'block';
            goToStep(0);
        }

        function goToStep(stepNum) {
            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            currentStep = stepNum;
            document.getElementById(`step${stepNum}`).classList.add('active');
            updateProgress();

            const prevBtns = [
                document.getElementById('prevBtn1'),
                document.getElementById('prevBtn2'),
                document.getElementById('prevBtn3'),
                document.getElementById('prevBtn4'),
                document.getElementById('prevBtn5')
            ];
            prevBtns.forEach(btn => {
                if (btn) {
                    btn.style.display = (currentStep > 0 && currentStep <= 5) ? 'inline-block' : 'none';
                }
            });
        }

        function updateProgress() {
            const totalSteps = 5;
            const adjustedStep = Math.max(0, currentStep - 1);
            const progress = (adjustedStep / totalSteps) * 100;
            document.getElementById('progressFill').style.width = `${progress}%`;
        }

        function initializeFESQuestions() {
            const container = document.getElementById('fesQuestions');
            container.innerHTML = '';
            fesQuestions.forEach((question, index) => {
                const questionId = `fes${index + 1}`;
                const questionDiv = document.createElement('div');
                questionDiv.className = 'question';
                questionDiv.innerHTML = `
                    <label>${index + 1}. ${question}</label>
                    <div class="likert-scale">
                        <div class="likert-option" data-value="1" onclick="selectLikert(this, '${questionId}', 1)">
                            <div>Not at all concerned</div>
                            <div><strong>1</strong></div>
                        </div>
                        <div class="likert-option" data-value="2" onclick="selectLikert(this, '${questionId}', 2)">
                            <div>Somewhat concerned</div>
                            <div><strong>2</strong></div>
                        </div>
                        <div class="likert-option" data-value="3" onclick="selectLikert(this, '${questionId}', 3)">
                            <div>Fairly concerned</div>
                            <div><strong>3</strong></div>
                        </div>
                        <div class="likert-option" data-value="4" onclick="selectLikert(this, '${questionId}', 4)">
                            <div>Very concerned</div>
                            <div><strong>4</strong></div>
                        </div>
                    </div>
                `;
                container.appendChild(questionDiv);

                if (assessmentData[questionId]) {
                    const selectedOption = questionDiv.querySelector(`.likert-option[data-value="${assessmentData[questionId]}"]`);
                    if (selectedOption) {
                        selectedOption.classList.add('selected');
                    }
                }
            });
        }

        function selectLikert(element, questionId, value) {
            element.parentNode.querySelectorAll('.likert-option').forEach(opt => {
                opt.classList.remove('selected');
            });
            element.classList.add('selected');
            assessmentData[questionId] = value;
        }

        function initializeTMT() {
            const grid = document.getElementById('tmtGrid');
            grid.innerHTML = '';
            const numbers = Array.from({length: 13}, (_, i) => i + 1);
            const shuffled = numbers.sort(() => Math.random() - 0.5);

            shuffled.forEach(num => {
                const circle = document.createElement('div');
                circle.className = 'tmt-circle';
                circle.textContent = num;
                circle.dataset.number = num;
                circle.onclick = () => clickTMTNumber(num, circle);
                grid.appendChild(circle);
            });

            document.getElementById('tmtTimer').textContent = 'Ready to start';
            document.getElementById('tmtStartBtn').style.display = 'inline-block';
            document.getElementById('tmtNextBtn').disabled = true;
        }

        function startTMT() {
            tmtStartTime = Date.now();
            tmtCurrentNumber = 1;
            tmtCompleted = false;

            document.getElementById('tmtStartBtn').style.display = 'none';
            const firstCircle = document.querySelector('[data-number="1"]');
            if (firstCircle) {
                firstCircle.classList.add('current');
            }

            updateTMTTimer();
        }

        function updateTMTTimer() {
            if (!tmtStartTime || tmtCompleted) return;

            const elapsed = (Date.now() - tmtStartTime) / 1000;
            document.getElementById('tmtTimer').textContent = `Time: ${elapsed.toFixed(1)}s`;

            requestAnimationFrame(updateTMTTimer);
        }

        function clickTMTNumber(number, element) {
            if (!tmtStartTime || tmtCompleted) return;

            if (number === tmtCurrentNumber) {
                element.classList.remove('current');
                element.classList.add('completed');

                tmtCurrentNumber++;

                if (tmtCurrentNumber <= 13) {
                    const nextCircle = document.querySelector(`[data-number="${tmtCurrentNumber}"]`);
                    if (nextCircle) {
                        nextCircle.classList.add('current');
                    }
                } else {
                    tmtCompleted = true;
                    const totalTime = (Date.now() - tmtStartTime) / 1000;
                    assessmentData.tmtTime = totalTime;

                    document.getElementById('tmtTimer').textContent = `Completed in ${totalTime.toFixed(1)}s`;
                    document.getElementById('tmtNextBtn').disabled = false;
                }
            }
        }

        function convertToMetric(heightInInches, weightInPounds) {
            const heightCm = heightInInches * 2.54;
            const weightKg = weightInPounds * 0.453592;
            return { heightCm, weightKg };
        }

        function nextStep() {
            if (!validateCurrentStep()) {
                alert('Please complete all required fields for this step.');
                return;
            }

            collectCurrentStepData();

            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep++;
            goToStep(currentStep);

            if (currentStep > 5) {
                calculateResults();
            }
        }

        function prevStep() {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            currentStep--;
            goToStep(currentStep);
        }

        function validateCurrentStep() {
            if (currentStep === 1) {
                return document.getElementById('age').value &&
                       document.getElementById('gender').value &&
                       document.getElementById('height').value &&
                       document.getElementById('weight').value;
            } else if (currentStep === 2) {
                return fesQuestions.every((_, i) => assessmentData[`fes${i + 1}`] !== undefined);
            } else if (currentStep === 3) {
                return document.getElementById('ipaq1a').value !== '' &&
                       document.getElementById('ipaq1b').value !== '' &&
                       document.getElementById('ipaq2a').value !== '' &&
                       document.getElementById('ipaq2b').value !== '';
            } else if (currentStep === 4) {
                return tmtCompleted;
            }
            return true;
        }

        function collectCurrentStepData() {
            if (currentStep === 1) {
                assessmentData.age = parseInt(document.getElementById('age').value);
                assessmentData.gender = document.getElementById('gender').value;

                const heightInches = parseFloat(document.getElementById('height').value);
                const weightPounds = parseFloat(document.getElementById('weight').value);

                const { heightCm, weightKg } = convertToMetric(heightInches, weightPounds);

                assessmentData.height = heightCm;
                assessmentData.weight = weightKg;
                assessmentData.bmi = weightKg / ((heightCm / 100) ** 2);

            } else if (currentStep === 3) {
                assessmentData.ipaq1a = parseInt(document.getElementById('ipaq1a').value) || 0;
                assessmentData.ipaq1b = parseInt(document.getElementById('ipaq1b').value) || 0;
                assessmentData.ipaq2a = parseInt(document.getElementById('ipaq2a').value) || 0;
                assessmentData.ipaq2b = parseInt(document.getElementById('ipaq2b').value) || 0;
            }
        }

        function calculateResults() {
            let fesTotal = 0;
            fesQuestions.forEach((_, i) => {
                fesTotal += assessmentData[`fes${i + 1}`] || 1;
            });
            assessmentData.fesTotal = fesTotal;

            const vigorousMets = assessmentData.ipaq1a * assessmentData.ipaq1b * 8;
            const moderateMets = assessmentData.ipaq2a * assessmentData.ipaq2b * 4;
            assessmentData.ipaqScore = vigorousMets + moderateMets;

            let predictedScore = 28;

            if (assessmentData.age > 65) predictedScore -= 3;
            else if (assessmentData.age > 45) predictedScore -= 1;

            if (assessmentData.bmi > 30) predictedScore -= 2;
            else if (assessmentData.bmi < 18.5) predictedScore -= 1;

            if (fesTotal >= 40) predictedScore -= 4;
            else if (fesTotal >= 30) predictedScore -= 3;
            else if (fesTotal >= 20) predictedScore -= 1;

            if (assessmentData.tmtTime > 30) predictedScore -= 3;
            else if (assessmentData.tmtTime > 20) predictedScore -= 1;

            if (assessmentData.ipaqScore > 3000) predictedScore += 2;
            else if (assessmentData.ipaqScore < 600) predictedScore -= 2;

            predictedScore = Math.max(0, Math.min(28, predictedScore));
            finalPredictedScore = predictedScore;

            displayResults(predictedScore);
        }

        function displayResults(score) {
            const quizContainer = document.getElementById('quizContainer');
            const mainContent = document.getElementById('mainContent');
            const resultsPane = document.getElementById('resultsPane');

            quizContainer.style.opacity = 0;
            setTimeout(() => {
                quizContainer.style.display = 'none';

                mainContent.style.display = 'flex';
                mainContent.style.opacity = 1;
                mainContent.style.pointerEvents = 'auto';

                resultsPane.classList.add('full-screen-results');

                document.getElementById('predictedScore').textContent = score.toFixed(1);

                let interpretation = '';
                let recommendations = '';

                if (score >= 24) {
                    interpretation = 'Excellent balance! Low fall risk.';
                    recommendations = 'Continue your current activity level and consider challenging balance exercises to maintain your excellent balance.';
                } else if (score >= 20) {
                    interpretation = 'Good balance with mild impairment.';
                    recommendations = 'Consider incorporating more balance training exercises (e.g., tai chi, yoga, standing on one leg) and regular physical activity into your routine to further improve and maintain your balance.';
                } else if (score >= 16) {
                    interpretation = 'Moderate balance impairment. Increased fall risk.';
                    recommendations = 'Balance training is highly recommended. You should consider consulting a healthcare provider or a physical therapist for a personalized balance assessment and tailored exercise program.';
                } else {
                    interpretation = 'Significant balance impairment. High fall risk.';
                    recommendations = 'It is strongly advised that you consult with a healthcare provider, such as a doctor or physical therapist, for a comprehensive balance assessment and to develop a specialized training and fall prevention plan.';
                }

                document.getElementById('scoreInterpretation').innerHTML = `<p><strong>${interpretation}</strong></p>`;
                document.getElementById('recommendations').innerHTML = `<h3>Recommendations:</h3><p>${recommendations}</p>`;

                createComparisonChart(score);

                const exploreButton = document.createElement('button');
                exploreButton.textContent = 'Explore Your Results';
                exploreButton.className = 'explore-results-btn';
                exploreButton.onclick = () => window.location.href = '#introSection';

                const recommendationsDiv = document.getElementById('recommendations');
                recommendationsDiv.appendChild(exploreButton);
            }, 500);
        }

        function createComparisonChart(userScore) {
            const chartContainer = d3.select('#comparisonChart');
            chartContainer.selectAll("*").remove();

            const svg = chartContainer
                .append('svg')
                .attr('viewBox', `0 0 600 350`);

            const width = 600;
            const height = 350;
            const margin = {top: 40, right: 30, bottom: 60, left: 60};

            const data = [
                {range: '0-7', count: 5, color: '#ff6b6b'},
                {range: '8-15', count: 15, color: '#feca57'},
                {range: '16-23', count: 45, color: '#48dbfb'},
                {range: '24-28', count: 35, color: '#1dd1a1'}
            ];

            const x = d3.scaleBand()
                .domain(data.map(d => d.range))
                .range([margin.left, width - margin.right])
                .padding(0.1);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data, d => d.count) * 1.1])
                .range([height - margin.bottom, margin.top]);

            svg.selectAll('rect')
                .data(data)
                .enter()
                .append('rect')
                .attr('x', d => x(d.range))
                .attr('y', d => y(d.count))
                .attr('width', x.bandwidth())
                .attr('height', d => height - margin.bottom - y(d.count))
                .attr('fill', d => d.color)
                .attr('opacity', 0.8);

            const userRange = userScore <= 7 ? '0-7' :
                             userScore <= 15 ? '8-15' :
                             userScore <= 23 ? '16-23' : '24-28';

            const userXPos = x(userRange) + x.bandwidth() / 2;

            svg.append('line')
                .attr('x1', userXPos)
                .attr('x2', userXPos)
                .attr('y1', y(d3.max(data, d => d.count) * 1.05))
                .attr('y2', height - margin.bottom)
                .attr('stroke', '#2c3e50')
                .attr('stroke-width', 3)
                .attr('stroke-dasharray', '5,5');

            svg.append('text')
                .attr('x', userXPos)
                .attr('y', y(d3.max(data, d => d.count) * 1.05) - 10)
                .attr('text-anchor', 'middle')
                .attr('font-weight', 'bold')
                .attr('fill', '#2c3e50')
                .text('Your Score');

            svg.append('g')
                .attr('transform', `translate(0,${height - margin.bottom})`)
                .call(d3.axisBottom(x))
                .selectAll("text")
                .style("font-size", "12px");

            svg.append('g')
                .attr('transform', `translate(${margin.left},0)`)
                .call(d3.axisLeft(y).tickFormat(d => `${d}%`))
                .selectAll("text")
                .style("font-size", "12px");

            svg.append('text')
                .attr('x', width / 2)
                .attr('y', height - 10)
                .attr('text-anchor', 'middle')
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .text('Mini-BESTest Score Range');

            svg.append('text')
                .attr('transform', 'rotate(-90)')
                .attr('x', -height / 2)
                .attr('y', 20)
                .attr('text-anchor', 'middle')
                .style("font-size", "14px")
                .style("font-weight", "bold")
                .text('Number of Participants (%)');

            svg.append("text")
                .attr("x", (width / 2))
                .attr("y", margin.top / 2 + 5)
                .attr("text-anchor", "middle")
                .style("font-size", "18px")
                .style("font-weight", "bold")
                .text("Your Score vs. Population Distribution");
        }

        function downloadScore() {
            if (finalPredictedScore === null) {
                alert("Score not yet calculated. Please complete the quiz.");
                return;
            }

            const scoreText = `Your Predicted Mini-BESTest Score: ${finalPredictedScore.toFixed(1)}\n` +
                              `Interpretation: ${document.getElementById('scoreInterpretation').textContent}\n` +
                              `Recommendations: ${document.getElementById('recommendations').textContent.replace('Recommendations:', '').trim()}`;

            const dataStr = "data:text/plain;charset=utf-8," + encodeURIComponent(scoreText);
            const dlAnchor = document.createElement('a');
            dlAnchor.setAttribute("href", dataStr);
            dlAnchor.setAttribute("download", "balance_score_summary.txt");
            dlAnchor.click();
        }

        function resetAssessment() {
            currentStep = 0;
            assessmentData = {};
            tmtCompleted = false;
            tmtCurrentNumber = 1;
            tmtStartTime = null;
            finalPredictedScore = null;

            document.querySelectorAll('.step').forEach(step => step.classList.remove('active'));
            document.getElementById('step0').classList.add('active');

            document.querySelectorAll('input').forEach(input => {
                if (input.type === 'number' || input.type === 'text') {
                    input.value = '';
                }
            });
            document.querySelectorAll('select').forEach(select => select.selectedIndex = 0);
            document.querySelectorAll('.likert-option').forEach(opt => opt.classList.remove('selected'));

            initializeTMT();

            document.getElementById('predictedScore').textContent = '';
            document.getElementById('scoreInterpretation').innerHTML = '';
            document.getElementById('recommendations').innerHTML = '';
            d3.select('#comparisonChart').selectAll("*").remove();

            document.getElementById('mainContent').style.opacity = 0;
            document.getElementById('mainContent').style.pointerEvents = 'none';
            setTimeout(() => {
                document.getElementById('mainContent').style.display = 'none';
            }, 500);

            document.getElementById('quizContainer').style.display = 'block';
            document.getElementById('quizContainer').style.opacity = 1;
            document.getElementById('quizContainer').scrollTop = 0;

            updateProgress();
        }

        // Initialize everything when the page loads
        window.addEventListener('load', function() {
            // Initialize canvas
            if (mainCanvas) {
                mainCanvas.width = mainCanvas.offsetWidth;
                mainCanvas.height = mainCanvas.offsetHeight;
            }
            
            // Setup scrollytelling
            if (typeof scrollama !== 'undefined') {
                setupScrollama();
            } else {
                useScrollFallback();
            }
            
            // Initialize with intro
            currentActiveAge = 'intro';
            updateBalanceIndicator('intro');
            drawBalanceVisualization(mainCtx, currentActiveAge);

            // Initialize quiz components
            initializeFESQuestions();
            initializeTMT();
            
            // Set up initial state
            document.getElementById('introSection').style.display = 'block';
            document.getElementById('quizContainer').style.display = 'none';
            document.getElementById('mainContent').style.display = 'none';

            // Add event listener for quiz start button
            document.getElementById('toQuizbtn').addEventListener('click', startQuizFromIntro);
        });
    </script>
</body>
</html>